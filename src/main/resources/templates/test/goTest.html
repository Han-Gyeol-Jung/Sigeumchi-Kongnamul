<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:value="http://www.w3.org/1999/xhtml">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
    <style>
        .errorBlue{
            color: #005cbf;
        }
    </style>
</head>

<body>
<img src="../img/eodeoddl.jpg" alt="멍댕이" width="250px" height="180px">
<h1 th:text="${testId}"> thymeleaf 테스트 식별자 표시 오류</h1>
<h1 th:text="${testName}"> thymeleaf 테스트 이름 표시 오류</h1>
############################## <table class="table table-striped">
    <thead>
    <tr>
        <th>순위</th>
        <th>이름</th>
        <th>조회수</th>
        <th></th>
    </tr>
    </thead>
    <tbody>
    <tr th:each="srt : ${sorted}">
        <td th:text="${srtStat.count}"></td>
        <td th:text="${srt.getTestName()}"></td>
        <td th:text="${srt.getCount()}"></td>
    </tr>
    </tbody>
</table>

<div th:if="${session.userSession != null}">
    <input type="button"  th:value="|세션 활성화 ${session.userSession} 안녕|" value="세션 활성화">
</div>
<form id="comment"  method="post" th:if="${session.userSession!=null}">
    <textarea cols="25" rows="5" id="textBox" name="textBox" placeholder="댓글 입력"></textarea>
    <button type="button" onclick="addComment()"> 댓 글 등 록 </button>
    <input type="hidden" id="userName" name="userName" th:value="${session.userSession}" value="세션 만료 오류">
</form>

<form id="noSession"  method="post" th:if="${session.userSession==null}">
    <textarea cols="25" rows="5" id="" name="" placeholder="세션이 없어요. 로그인해 주세요." disabled="disabled">
    </textarea>
</form>

<hr>
<strong th:text="${authError}" class="errorBlue"></strong>
<form  id="commentUpdate"  method="post"  hidden="hidden" th:if="${session.userSession!=null}">
    <input type="text"  cols="25" rows="5" id="textBoxU" name="textBoxU" placeholder="댓글 수정"></textarea>
    <button type="button" onclick="updateComment()"> 댓글 수정 </button>
    <input type="hidden" id="userNameU" name="userNameU" th:value="${session.userSession}" value="세션 만료 오류">
    <input type="hidden" id="commRow" name="commRow" value="">
    <input type="hidden" id="commId" name="commId" value="">
</form>

<table id="userList" >
    <tr>
        <td>댓글 식별자</td>
        <td>이름</td>
        <td>내용</td>
        <td>좋아요</td>
        <td>소속 테스트 식별자(pathVar)</td>
        <td>수정</td>
        <td>삭제</td>
        <td></td>
    </tr>
    <tr th:each="co : ${comments}" >
        <td th:text="${co.id}" ></td>
        <td th:text="${co.commentData.userName}"></td>
        <td th:text="${co.commentData.content}"></td>
        <td th:text="${co.commentData.likes}"></td>
        <td th:text="${co.testEntity.id}"></td>
        <td><button type="button"  th:onclick="|showUpdateArea(${coStat.index})|">수정</button> <input type="hidden"
                           th:id="|commentIndexUpdate${coStat.index}|"
                           name="commentIndexUpdate" id="commentIndexUpdate" th:value="${coStat.index}"></td>
        <td><button type="button"  th:onclick="|deleteComment(${coStat.index})|">삭제</button> <input type="hidden"
                           name="commentIndexDelete" id="commentIndexDelete" th:value="${coStat.index}"> </td>
    </tr>
</table>

<script>
    // function getUserName() {
    //     let userList = document.getElementById('userList');
    //
    //     for (let i = 1; i < userList.rows.length; i++) {
    //         userList.rows[i].cells[2].onclick = function () {
    //             let userName = userList.rows[i].cells[1].innerText;
    //             alert(userName+"을 선택하셨습니다.");
    //         }
    //     }
    // }
    function addComment() {
        let form = document.getElementById("comment");

        let url = window.location.href+"/addComment";
        form.setAttribute("action", url)

        let name = document.getElementById("userName");
        form.submit();
    }
    function showUpdateArea(index){
        let form = document.getElementById("commentUpdate");
        form.removeAttribute("hidden"); // 가린거 드러내기
        let userList = document.getElementById('userList');
        /**
         * hidden 속성 엘리먼트에 행값 숨겨넣기
        */
        let indexElement = document.getElementById("commRow");
        indexElement.setAttribute("value", index);
    }
    function updateComment(){
        // TextArea쪽에서 post form 가져옴
        let form = document.getElementById("commentUpdate")
        let url = window.location.href+"/updateComment";
        let userList = document.getElementById('userList');
        let index = document.getElementById("commRow").value;
        index++;
        let commentId = userList.rows[index].cells[0].innerText;  // 행값 index에 해당하는 댓글ID값

        let commId = document.getElementById("commId");
        commId.setAttribute("value", commentId);
        form.setAttribute("action", url);

        form.submit();
    }

    function deleteComment(index){
        /**  Form.과 Input.을 직접 만들어 제출. Input  type="hidden"에는 row Index
         */
        let form = document.createElement("form");
        let input = document.createElement("input");
        let url = window.location.href+"/deleteComment";
        let userList = document.getElementById('userList');
        index++;
        let commentId = userList.rows[index].cells[0].innerText;  // 행값 index에 해당하는 댓글ID값
        form.setAttribute("method", "post");
        form.setAttribute("action", url);
        input.setAttribute("type", "hidden");
        input.setAttribute("value", commentId); input.setAttribute("name", "commentId");
        form.appendChild(input);
        document.body.appendChild(form);

        form.submit();
    }
</script>

</body>
