<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:value="http://www.w3.org/1999/xhtml">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-BmbxuPwQa2lc/FVzBcNJ7UAyJxM6wuqIj61tLrc4wSX0szH/Ev+nYRRuWlolflfl" crossorigin="anonymous">
    <link rel="preconnect" href="https://fonts.gstatic.com">

    <link href="https://fonts.googleapis.com/css2?family=Nanum+Pen+Script&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="../css/default.css">
    <link rel="stylesheet" href="../css//main.css">
    <link rel="stylesheet" href="../css/qna.css">
    <link rel="stylesheet" href="../css/animation.css">
    <link rel="stylesheet" href="../css/result.css">

    <title>Title</title>

    <style>
        .errorBlue{
            color: #005cbf;
        }
        table{
            border-spacing: 20px;
            border-collapse: separate;
        }
        #viewTable{
            width: 40%;
            display: inline-block;
            margin-left: 120px;
            margin-top: 30px;
        }
    </style>
</head>
<body>
<script type="text/javascript" src="http://code.jquery.com/jquery-3.5.1.min.js"></script>
<script>
    window.onload = function () {
        let path = [[${path}]]; // 모델을 타임리프 문법으로 js로 가져오기
        switch (path){
            case 1:
                document.getElementById('title').innerHTML="스마트폰 중독 테스트";
                document.querySelector(".desc").innerText=" 우리는 스마트폰에 얼마나 의존할까요? "
                break;
            case 2:
                document.getElementById('title').innerHTML="내게 맞는 웹 프로그래밍 언어";
                document.querySelector(".desc").innerText="어떤 언어로 프로그래밍을 시작해 볼까요? "
                break;
            case 3:
                document.getElementById('title').innerHTML="내향성 테스트";
                document.querySelector(".desc").innerText="나의 성격을 알아봅시다. "
                break;
            case 4:
                document.getElementById('title').innerHTML="4번 테스트"; break;
        }
    }
</script>

<div class="container">
    <section id="main" class="ml-3 my-5 py-5 px-3">
        <h1 id="title">테스트제목임</h1>
        <div class="col-lg-6 col-md-8 col-sm-10 col-12 mx-auto">
            <img src="../img/eodeoddl.jpg" alt="mainImage" class="img-fluid">
        </div>
        <p class="desc">
            아래 시작하기 버튼을 눌러 시작해 주세요!
        </p>
        <button type="button" class="btn btn-outline-danger mt-3" onclick="js:begin()">시작하기</button>
    </section>

  <div style="position: absolute; right: 0px; top: 0px;  width:700px;">
    <table  id="viewTable" class="table table-striped" >
        <thead>
        <tr>
            <th>순위</th>
            <th>이름</th>
            <th>조회수</th>
            <th></th>
        </tr>
        </thead>
        <tbody>
        <tr th:each="srt : ${sorted}">
            <td>
                <a th:href="|/test/${srt.getId()}|">
                    <div th:text="${srtStat.count}"></div>
                </a>
            </td>
            <td>
                <a th:href="|/test/${srt.getId()}|">
                    <div th:text="${srt.getTestName()}"></div>
                </a>
            </td>
            <td th:text="${srt.getView()}"></td>
        </tr>
        </tbody>
    </table>
  </div>

    <section id="qna" class="ml-3 my-5 py-5 px-3">
        <div class="status  mt-5">
            <div class="statusBar">
            </div>
        </div>

        <div class="qBox my-5 py-3 ">

        </div>
        <div class="answerBox">

        </div>
    </section>

    <section id="result" class="ml-3 my-5 py-5 px-3">
        <h1>당신의 결과는?!</h1>
        <div class="resultname">

        </div>
        <div id="resultImg" class="my-3 col-lg-6 col-md-8 col-sm-10 col-12 mx-auto">

        </div>
        <div class="resultDesc">

        </div>
        <div id="SharePopup" class="popup-layer">
            <div class="box-share-sns">
              <button type="button" onClick="sendLinkCustom();" value="Custom"
                      class="kakao mt-3 py-2 px-3" >공유하기</button>
            </div>

            <div class="share-url">
                <input type="text" id = "ShareUrl" >
                <span class="btn-type1"><button OnClick="javascript:CopyUrlToClipboard()">URL 복사</button></span>
            </div>
        </div>

    </section>

</div>
<h3 th:text="${testName}"> thymeleaf 테스트 이름 표시 오류</h3>

<hr>

<div th:if="${session.userSession != null}">
    <input type="button"  th:value="|세션 활성화 ${session.userSession} 안녕|" value="세션 활성화">
</div>
<form id="comment"  method="post" th:if="${session.userSession!=null}">
    <textarea cols="25" rows="5" id="textBox" name="textBox" placeholder="댓글 입력"></textarea>
    <button type="button" onclick="addComment()"> 댓 글 등 록 </button>
    <input type="hidden" id="userName" name="userName" th:value="${session.userSession}" value="세션 만료 오류">
</form>

<form id="noSession"  method="post" th:if="${session.userSession==null}">
    <textarea cols="25" rows="5" id="" name="" placeholder="세션이 없어요. 로그인해 주세요." disabled="disabled">
    </textarea>
</form>

<hr>

<strong th:text="${authError}" class="errorBlue"></strong>
<strong id="CRUDandLikeError" class="errorBlue" style="display: none;">likeError</strong>


<form  id="commentUpdate"  method="post"  hidden="hidden" th:if="${session.userSession!=null}">
    <input type="text"  cols="25" rows="5" id="textBoxU" name="textBoxU" placeholder="댓글 수정"></textarea>
    <button type="button" onclick="updateComment()"> 댓글 수정 </button>
    <input type="hidden" id="userNameU" name="userNameU" th:value="${session.userSession}" value="세션 만료 오류">
    <input type="hidden" id="commRow" name="commRow" value="">
    <input type="hidden" id="commId" name="commId" value="">
</form>

<table id="userList" >
    <thead>
    <tr>
        <td>댓글 식별자</td>
        <td>이름</td>
        <td>내용</td>
        <td>좋아요</td>
        <td>소속 테스트 식별자(pathVar)</td>
        <td>수정</td>
        <td>삭제</td>
    </tr>
    </thead>
    <tbody>
    <tr th:each="co : ${comments}" >
        <td th:text="${co.id}" ></td>
        <td th:text="${co.commentData.userName}"></td>
        <td th:text="${co.commentData.content}"></td>
        <td><button th:onclick="|addLike(${coStat.index})|" type="button"  th:text="${co.commentData.likes}">
                </button> </td>
        <td th:text="${co.testEntity.id}"></td>
        <td><button type="button"  th:onclick="|showUpdateArea(${coStat.index})|">수정</button>
            <input type="hidden" th:id="|commentIndexUpdate${coStat.index}|"
                           name="commentIndexUpdate" id="commentIndexUpdate" th:value="${coStat.index}"></td>
        <td><button type="button"  th:onclick="|deleteComment(${coStat.index})|">삭제</button> <input type="hidden"
                           name="commentIndexDelete" id="commentIndexDelete" th:value="${coStat.index}"> </td>
    </tr>
    </tbody>
</table>
<script type="text/JavaScript" src="https://developers.kakao.com/sdk/js/kakao.min.js"></script>
<script src="../js/like2.js" charset="utf-8"></script>
<script th:src="|../js/data${path}.js|" charset="utf-8"></script>
<script th:src="|../js/start${path}.js|" charset="utf-8"></script>

<script>
    function addComment() {
        let form = document.getElementById("comment");

        let url = window.location.href+"/addComment";
        form.setAttribute("action", url)

        let name = document.getElementById("userName");
        form.submit();
    }
    function showUpdateArea(index){ // 수정버튼을 눌렀을 때
        let form = document.getElementById("commentUpdate");
        form.removeAttribute("hidden"); // 가린거 드러내기
        let userList = document.getElementById('userList');
        /**
         * hidden 속성 엘리먼트에 행값 숨겨넣기
        */
        let indexElement = document.getElementById("commRow");
        indexElement.setAttribute("value", index);
    }
    function updateComment(){
        // TextArea쪽에서 post form 가져옴
        let userList = document.getElementById('userList');
        let index = document.getElementById("commRow").value;
        index++;
        let commentId = userList.rows[index].cells[0].innerText;  // 행값 index에 해당하는 댓글ID값
        let content=document.getElementById("textBoxU").value;

        let data={
            commentId:commentId,
            content: content
        }
        $.ajax({
            type: "POST",
            url: "/test/updateComment",
            data: JSON.stringify(data), // 자바스크립트 오브젝트인 let data를 Json 문자열로 전환해 body에 전달
            contentType: "application/json; charset=utf-8", // request body 데이터 타입
            dataType: "json",  // response를 어떤 식으로 받을 것인지.  json이 오면 자바스크립트 오브젝트로 변환됨
        }).done(function (resp){ // 자동 parse
            // 위 ajax절 결과가 정상일 시 실행, fail은 비정상 시 실행
            if("수정 권한 없음" === resp.updateResult){
                $("#CRUDandLikeError").text(resp.updateResult);
                $("#CRUDandLikeError").show();
            } else if("수정 정상 처리"===resp.updateResult){
                userList.rows[index].cells[2].innerHTML = content;
                document.getElementById("textBoxU").value='';
            }
        }).fail(function (error){
            alert(JSON.stringify(error));
        });
    }
    // function updateComment(){
    //     // TextArea쪽에서 post form 가져옴
    //     let form = document.getElementById("commentUpdate")
    //     let url = window.location.href+"/updateComment";
    //     let userList = document.getElementById('userList');
    //     let index = document.getElementById("commRow").value;
    //     index++;
    //     let commentId = userList.rows[index].cells[0].innerText;  // 행값 index에 해당하는 댓글ID값
    //
    //     let commId = document.getElementById("commId");
    //     commId.setAttribute("value", commentId);
    //     form.setAttribute("action", url);
    //
    //     form.submit();
    // }


    function deleteComment(index){
        /**  Form.과 Input.을 직접 만들어 제출. Input  type="hidden"에는 row Index
         */
        let form = document.createElement("form");
        let input = document.createElement("input");
        let url = window.location.href+"/deleteComment";
        let userList = document.getElementById('userList');
        index++;
        let commentId = userList.rows[index].cells[0].innerText;  // 행값 index에 해당하는 댓글ID값
        form.setAttribute("method", "post");
        form.setAttribute("action", url);
        input.setAttribute("type", "hidden");
        input.setAttribute("value", commentId); input.setAttribute("name", "commentId");
        form.appendChild(input);
        document.body.appendChild(form);
        alert("댓글을 삭제합니다.");

        form.submit();
    }

</script>
<!-- Layer POPUP -->  <!--  display none -->

<!-- Layer POPUP -->
<script type="text/javascript">
    function sendLinkCustom() {
        Kakao.init("a19b5bbf9d8a077d08e6f4ab324883fb");
        Kakao.Link.sendCustom({
            templateId: 58910
        });
    }
</script>
<script>
    function CopyUrlToClipboard() {
        var obShareUrl = document.getElementById("ShareUrl");
        obShareUrl.select();  // 해당 값이 선택되도록 select() 합니다
        document.execCommand("copy"); // 클립보드에 복사합니다.
        obShareUrl.blur(); // 선택된 것을 다시 선택안된것으로 바꿉니다.
        alert("URL이 클립보드에 복사되었습니다");
    }
</script>


</body>
